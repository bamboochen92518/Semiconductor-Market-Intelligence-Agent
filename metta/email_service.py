import smtplib
import os
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from datetime import datetime
from typing import Optional

class EmailService:
    """éƒµä»¶æœå‹™é¡ï¼Œç”¨æ–¼ç™¼é€åŠå°é«”å¸‚å ´å ±å‘Šå’Œè­¦å ±"""
    
    def __init__(self):
        self.smtp_server = os.getenv("SMTP_SERVER", "smtp.gmail.com")
        self.smtp_port = int(os.getenv("SMTP_PORT", "587"))
        self.email_user = os.getenv("EMAIL_USER")
        self.email_password = os.getenv("EMAIL_PASSWORD")
        self.recipient_email = os.getenv("RECIPIENT_EMAIL")
        
        # Debug: æª¢æŸ¥å¯†ç¢¼æ˜¯å¦æ­£ç¢ºè®€å–
        if self.email_password:
            print(f"ğŸ” DEBUG: Password loaded, length: {len(self.email_password)} characters")
            print(f"ğŸ” DEBUG: Password starts with: '{self.email_password[:3]}...'")
        
        if not all([self.email_user, self.email_password, self.recipient_email]):
            print("âš ï¸  Warning: Email credentials not fully configured")
            print("   Please set EMAIL_USER, EMAIL_PASSWORD, RECIPIENT_EMAIL in .env file")
        else:
            print(f"âœ… Email credentials loaded: {self.email_user} -> {self.recipient_email}")
    
    def send_hourly_report(self, market_analysis: str) -> bool:
        """ç™¼é€æ•´é»å¸‚å ´å ±å‘Š"""
        current_time = datetime.now().strftime("%Y-%m-%d %H:00")
        
        # å°‡ Markdown è½‰æ›ç‚º HTML æ ¼å¼
        from .markdown_processor import markdown_processor
        html_analysis = markdown_processor.process_for_html_chat(market_analysis)
        
        subject = f"ğŸ“Š Semiconductor Market Hourly Report - {current_time}"
        
        html_body = f"""
        <html>
            <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
                <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
                    <h1 style="color: #2E86AB; border-bottom: 2px solid #2E86AB; padding-bottom: 10px;">
                        ğŸ­ Semiconductor Market Intelligence Report
                    </h1>
                    
                    <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <h2 style="color: #495057; margin-top: 0;">ğŸ“ˆ Market Summary ({current_time})</h2>
                        <div style="background-color: white; padding: 15px; border-radius: 5px; font-family: Arial, sans-serif; font-size: 14px; line-height: 1.6;">
{html_analysis}
                        </div>
                    </div>
                    
                    <div style="background-color: #e9ecef; padding: 10px; border-radius: 5px; margin-top: 20px; text-align: center; font-size: 12px; color: #6c757d;">
                        <p>ğŸ¤– Generated by Semiconductor Market Intelligence Agent</p>
                        <p>ğŸ“§ Automated hourly report delivered at {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
                    </div>
                </div>
            </body>
        </html>
        """
        
        return self._send_email(subject, html_body, email_type="hourly_report")
    
    def send_volatility_alert(self, stock_alerts: list) -> bool:
        """ç™¼é€è‚¡åƒ¹å¤§å¹…æ³¢å‹•è­¦å ±"""
        current_time = datetime.now().strftime("%Y-%m-%d %H:%M")
        
        subject = f"ğŸš¨ ALERT: Semiconductor Stock Volatility Detected - {current_time}"
        
        # æ§‹å»ºè­¦å ±å…§å®¹
        alert_content = ""
        for alert in stock_alerts:
            company = alert.get('company', 'Unknown')
            symbol = alert.get('symbol', 'N/A')
            change_percent = alert.get('change_percent', 0)
            current_price = alert.get('current_price', 'N/A')
            previous_price = alert.get('previous_price', 'N/A')
            trigger_reason = alert.get('trigger_reason', 'High volatility')
            time_period = alert.get('time_period', 'recent period')
            llm_analysis = alert.get('llm_analysis', '')
            severity = alert.get('severity', 'high')
            
            # æ ¹æ“šåš´é‡ç¨‹åº¦è¨­å®šé¡è‰²
            severity_color = '#dc3545' if severity == 'extreme' else '#fd7e14'
            
            alert_content += f"""
            <div style="border-left: 4px solid {severity_color}; padding-left: 15px; margin: 20px 0; background-color: #f8f9fa; border-radius: 0 8px 8px 0;">
                <h3 style="color: {severity_color}; margin: 0 0 10px 0;">{company} ({symbol})</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <p style="margin: 5px 0;"><strong>Current Price:</strong> ${current_price}</p>
                        <p style="margin: 5px 0;"><strong>Previous Price:</strong> ${previous_price}</p>
                    </div>
                    <div>
                        <p style="margin: 5px 0;"><strong>Change:</strong> <span style="color: {'red' if change_percent < 0 else 'green'}; font-weight: bold; font-size: 16px;">{change_percent:+.2f}%</span></p>
                        <p style="margin: 5px 0;"><strong>Period:</strong> {time_period}</p>
                    </div>
                </div>
                
                <p style="margin: 5px 0; font-size: 14px; color: #6c757d;"><strong>Trigger:</strong> {trigger_reason}</p>
                
                {f'''
                <div style="background-color: #e3f2fd; padding: 12px; border-radius: 6px; margin-top: 15px; border-left: 3px solid #2196f3;">
                    <h4 style="color: #1976d2; margin: 0 0 8px 0; font-size: 14px;">ğŸ¤– AI Analysis</h4>
                    <p style="margin: 0; font-size: 13px; line-height: 1.5;">{llm_analysis}</p>
                </div>
                ''' if llm_analysis else ''}
            </div>
            """
        
        html_body = f"""
        <html>
            <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
                <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
                    <h1 style="color: #dc3545; border-bottom: 2px solid #dc3545; padding-bottom: 10px;">
                        ğŸš¨ Semiconductor Stock Volatility Alert
                    </h1>
                    
                    <div style="background-color: #f8d7da; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #f5c6cb;">
                        <h2 style="color: #721c24; margin-top: 0;">âš ï¸ High Volatility Detected</h2>
                        <p style="margin-bottom: 0;">The following semiconductor stocks have experienced significant price movements in short timeframes:</p>
                    </div>
                    
                    <div style="background-color: #fff; border-radius: 8px; border: 1px solid #dee2e6;">
                        {alert_content}
                    </div>
                    
                    <div style="background-color: #d1ecf1; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #bee5eb;">
                        <h3 style="color: #0c5460; margin-top: 0;">ğŸ“‹ Recommended Actions</h3>
                        <ul style="margin: 0; padding-left: 20px;">
                            <li>Review the AI analysis for potential causes</li>
                            <li>Check trading volumes and market sentiment</li>
                            <li>Monitor news sources for breaking developments</li>
                            <li>Consider portfolio risk management if needed</li>
                            <li>Watch for continued volatility in the next period</li>
                        </ul>
                    </div>
                    
                    <div style="background-color: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #ffeaa7;">
                        <h3 style="color: #856404; margin-top: 0;">âš™ï¸ Alert Configuration</h3>
                        <ul style="margin: 0; padding-left: 20px; color: #856404;">
                            <li><strong>High Volatility:</strong> â‰¥5% movement in 5 minutes</li>
                            <li><strong>Extreme Volatility:</strong> â‰¥10% movement in 5 minutes</li>
                            <li><strong>Monitoring Frequency:</strong> Every 5 minutes</li>
                            <li><strong>AI Analysis:</strong> Powered by ASI:One LLM</li>
                        </ul>
                    </div>
                    
                    <div style="background-color: #e9ecef; padding: 10px; border-radius: 5px; margin-top: 20px; text-align: center; font-size: 12px; color: #6c757d;">
                        <p>ğŸ¤– Generated by Semiconductor Market Intelligence Agent</p>
                        <p>â° Alert triggered at {current_time}</p>
                        <p>ğŸ” This alert compares prices from 5 minutes ago vs current prices</p>
                    </div>
                </div>
            </body>
        </html>
        """
        
        return self._send_email(subject, html_body, email_type="volatility_alert")
    
    def send_startup_notification(self) -> bool:
        """ç™¼é€ç³»çµ±å•Ÿå‹•é€šçŸ¥éƒµä»¶"""
        current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        subject = f"ğŸš€ System Startup: Semiconductor Market Intelligence Agent - {current_time}"
        
        html_body = f"""
        <html>
            <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
                <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
                    <h1 style="color: #28a745; border-bottom: 2px solid #28a745; padding-bottom: 10px;">
                        ğŸš€ System Startup Notification
                    </h1>
                    
                    <div style="background-color: #d4edda; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #c3e6cb;">
                        <h2 style="color: #155724; margin-top: 0;">âœ… Agent Successfully Started</h2>
                        <p style="margin-bottom: 0;"><strong>Semiconductor Market Intelligence Agent is now online and ready!</strong></p>
                    </div>
                    
                    <div style="background-color: #fff; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; margin: 20px 0;">
                        <h3 style="color: #495057; margin-top: 0;">ğŸ“Š System Information</h3>
                        <ul style="margin: 0; padding-left: 20px;">
                            <li><strong>Startup Time:</strong> {current_time}</li>
                            <li><strong>Email Service:</strong> âœ… Configured and Working</li>
                            <li><strong>Scheduled Tasks:</strong> âœ… Automatically Started</li>
                            <li><strong>Stock Monitor:</strong> âœ… Monitoring 9 Companies</li>
                            <li><strong>Knowledge Graph:</strong> âœ… Initialized</li>
                        </ul>
                    </div>
                    
                    <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <h3 style="color: #495057; margin-top: 0;">ğŸ”§ Active Services</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            <div style="background-color: #007bff; color: white; padding: 8px 12px; border-radius: 5px; font-size: 14px;">
                                ğŸ“Š Hourly Reports
                            </div>
                            <div style="background-color: #dc3545; color: white; padding: 8px 12px; border-radius: 5px; font-size: 14px;">
                                ğŸš¨ Volatility Alerts
                            </div>
                            <div style="background-color: #28a745; color: white; padding: 8px 12px; border-radius: 5px; font-size: 14px;">
                                ğŸ“° News Analysis
                            </div>
                            <div style="background-color: #17a2b8; color: white; padding: 8px 12px; border-radius: 5px; font-size: 14px;">
                                ğŸ’¹ Stock Monitoring
                            </div>
                        </div>
                    </div>
                    
                    <div style="background-color: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #ffeaa7;">
                        <h3 style="color: #856404; margin-top: 0;">â° What to Expect</h3>
                        <ul style="margin: 0; padding-left: 20px; color: #856404;">
                            <li>ğŸ“Š Hourly market reports every hour at :00 minutes</li>
                            <li>ğŸš¨ Volatility alerts when stock movements exceed 5%</li>
                            <li>ğŸ“ˆ Continuous monitoring of NVIDIA, TSMC, Intel, AMD, and more</li>
                            <li>ğŸ’¬ Natural language queries about semiconductor market trends</li>
                        </ul>
                    </div>
                    
                    <div style="text-align: center; padding: 20px; background-color: #e9ecef; border-radius: 8px; margin-top: 20px;">
                        <h3 style="color: #495057; margin-top: 0;">ğŸ¯ Ready for Action</h3>
                        <p style="margin: 10px 0; color: #6c757d;">Your AI-powered semiconductor market analyst is now monitoring the markets 24/7</p>
                    </div>
                    
                    <div style="background-color: #e9ecef; padding: 10px; border-radius: 5px; margin-top: 20px; text-align: center; font-size: 12px; color: #6c757d;">
                        <p>ğŸ¤– Generated by Semiconductor Market Intelligence Agent</p>
                        <p>ğŸ“§ System startup notification sent at {current_time}</p>
                    </div>
                </div>
            </body>
        </html>
        """
        
        return self._send_email(subject, html_body, email_type="startup_notification")

    def _send_email(self, subject: str, html_body: str, email_type: str) -> bool:
        """ç™¼é€éƒµä»¶çš„å…§éƒ¨æ–¹æ³•"""
        if not all([self.email_user, self.email_password, self.recipient_email]):
            print(f"âŒ Cannot send {email_type}: Email credentials not configured")
            return False
        
        try:
            # å‰µå»ºéƒµä»¶
            msg = MIMEMultipart('alternative')
            msg['From'] = self.email_user
            msg['To'] = self.recipient_email
            msg['Subject'] = subject
            
            # æ·»åŠ HTMLå…§å®¹
            html_part = MIMEText(html_body, 'html')
            msg.attach(html_part)
            
            # ç™¼é€éƒµä»¶
            with smtplib.SMTP(self.smtp_server, self.smtp_port) as server:
                server.starttls()
                server.login(self.email_user, self.email_password)
                server.send_message(msg)
            
            print(f"âœ… {email_type} email sent successfully to {self.recipient_email}")
            return True
            
        except Exception as e:
            print(f"âŒ Failed to send {email_type} email: {e}")
            return False
    
    def test_email_connection(self) -> bool:
        """æ¸¬è©¦éƒµä»¶é€£æ¥"""
        test_subject = "ğŸ§ª Test Email from Semiconductor Market Agent"
        test_body = """
        <html>
            <body style="font-family: Arial, sans-serif;">
                <h2>âœ… Email Configuration Test</h2>
                <p>If you receive this email, your email configuration is working correctly!</p>
                <p><strong>Timestamp:</strong> {}</p>
            </body>
        </html>
        """.format(datetime.now().strftime('%Y-%m-%d %H:%M:%S'))
        
        return self._send_email(test_subject, test_body, email_type="test")

# å…¨å±€å¯¦ä¾‹
email_service = EmailService()